#############################################################################
######## This code takes the NTL-LTER data and looks at #####################
######## iceon trends (e.g. by month). For a given lake, ####################
######## TDN/TDP/N:P is along the y, with time along the x. #################
######## Time is either months since start of iceon or ######################
######## starting month (TBD). Each year is symbolized ######################
######## differently. The idea is to get a sense, pre-ARMA, #################
######## of possible iceon trends within the iceon season, ##################
######## lumping all available years together. Additionally, ################
######## depth is considered in different ways: the entire water ############
######## column, or split into photic zone and various non-photic zones. ####
######## This could potentially look at influence of mineralization #########
######## on nutrient concentrations. ########################################
#############################################################################
#Data was downloaded from the NTL-LTER public download page.
#To begin, we are only interested in chemical attribute.
#https://lter.limnology.wisc.edu/dataset/north-temperate-lakes-lter-chemical-limnology-primary-study-lakes-nutrients-ph-and-carbon-19
#://lter.limnology.wisc.edu/datafile/chemical-limnology-north-temperate-lakes-lter-primary-study-lakes-nutrients-ph-and-carbon
#in SL folder, this is CSV called "chemical_limnology_of_north_temperate_lakes_lter_primary_study_lakes_nutrients_ph_and_carbon_ALL.csv"
#nutrient samples: measured at one station in the deepest part of each lake at the top and bottom of the epilimnion, mid-thermocline, and top, middle, and bottom of the hypolimnion
#Oxygen data: https://lter.limnology.wisc.edu/dataset/north-temperate-lakes-lter-physical-limnology-primary-study-lakes-1981-current
#measured at one station in the deepest part of each lake at 0.25-m to 1-m depth intervals depending on the lake.
#in SL folder, this is CSV called "physical_limnology_of_the_north_temperate_lakes_primary_study_lakes_ALL.csv"
#looks to generally be same sample dates as nutrients (but different depths - not always the same)
#snow and ice data: https://lter.limnology.wisc.edu/dataset/north-temperate-lakes-lter-snow-and-ice-depth-1982-current
rm(list = ls())
#setwd("D:Labou//UnderIce/Phys-Chem-Bio/NTL-LTER")
#base_dir<-"/Users/steve.powers/Desktop/Sandboxes/2016Mar8pm_IcePowers"
start_dir<-as.character(getwd())
start_dir
base_dir<-start_dir
base_dir<-substr(start_dir,1,nchar(start_dir)-nchar("/Scripts"))
data_dir<-paste(base_dir,"/Data",sep="")
base_dir
#######################################################################################
######## This codes uses the NTL-LTER data to investigate nutrient ####################
######## trends under lake ice. For a given lake, TDN/TDP/N:P is ######################
######## plotted against days since iceon. Depth is considered in #####################
######## different ways, with portions of code dedicated to determining ###############
######## hypsometrically weighted nutrient concentrations. Additionally, ##############
######## oxygen is investigated in relation to both nutrient concentrations ###########
######## and whole lake trends during iceon. Oxygen too! ##########################################
#######################################################################################
#################### Information about NTL-LTER data used here ########################
#Data was downloaded from the NTL-LTER public download page.
#chemical linology
#https://lter.limnology.wisc.edu/dataset/north-temperate-lakes-lter-chemical-limnology-primary-study-lakes-nutrients-ph-and-carbon-19
#://lter.limnology.wisc.edu/datafile/chemical-limnology-north-temperate-lakes-lter-primary-study-lakes-nutrients-ph-and-carbon
#this is CSV called "chemical_limnology_of_north_temperate_lakes_lter_primary_study_lakes_nutrients_ph_and_carbon_ALL.csv"
#nutrient samples: measured at one station in the deepest part of each lake at the top and bottom of the epilimnion, mid-thermocline, and top, middle, and bottom of the hypolimnion
#physical limnology, including oxygen
#https://lter.limnology.wisc.edu/dataset/north-temperate-lakes-lter-physical-limnology-primary-study-lakes-1981-current
#measured at one station in the deepest part of each lake at 0.25-m to 1-m depth intervals depending on the lake.
#this is CSV called "physical_limnology_of_the_north_temperate_lakes_primary_study_lakes_ALL.csv"
#snow and ice data: https://lter.limnology.wisc.edu/dataset/north-temperate-lakes-lter-snow-and-ice-depth-1982-current
############################################################################
################ start session and set up dependencies #####################
############################################################################
rm(list = ls())
#base_dir<-"/Users/steve.powers/Desktop/Sandboxes/2016Mar8pm_IcePowers"
#start_dir<-as.character(getwd())
#base_dir<-start_dir
#base_dir<-substr(start_dir,1,nchar(start_dir)-nchar("/Scripts"))
#data_dir<-paste(base_dir,"/Data",sep="")
#figs_dir<-paste(base_dir,"/Figures",sep="")
#base_dir<-"/Users/spowers/Desktop/Sandboxes/2016Mar16"
#data_dir<-paste(c(base_dir,"/DataAsText"),collapse="")
#setwd(base_dir)
library(plyr)
library(dplyr)
library(ggplot2)
library(grid)
library(tidyr)
library(MESS)
#library(lme4)
#######################################################################
####################### read in data - all ############################
#################### do some renameing, etc. ##########################
#######################################################################
#read in original synthesis data for Wisconsin lakes
data.agg.orig <- read.csv("./Data/wisconsin_under_ice_aggregate_lakes.csv", stringsAsFactors = FALSE)
#elevations (see script...)
data.elevs.orig <- read.csv("./Data/final_elevs.csv", stringsAsFactors = FALSE)
data.elevs <- data.elevs.orig %>% rename(year4 = yr_winter)
#physical limnology data for LTER lakes
data.lter.phys.orig <- read.csv("./Data/physical_limnology_of_the_north_temperate_lakes_primary_study_lakes_ALL.csv",
stringsAsFactors = FALSE)
data.lter.phys <- data.lter.phys.orig
data.lter.phys$lakeid <- gsub("AL", "Allequash Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("BM", "Big Musky Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("CB", "Crystal Bog", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("CR", "Crystal Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("SP", "Sparkling Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("TB", "Trout Bog", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("TR", "Trout Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("FI", "Fish Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("ME", "Lake Mendota", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("MO", "Lake Monona", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("WI", "Lake Wingra", data.lter.phys$lakeid)
data.lter.phys <- filter(data.lter.phys, lakeid != "Fish Lake" & lakeid != "Lake Mendota" & lakeid != "Lake Monona" & lakeid != "Lake Wingra")
#merge physical and lake_elev data
data.lter.phys <- merge(data.lter.phys, data.elevs, by = c("lakeid", "year4"))
#nutrient data for LTER lakes
data.lter.nutrients.orig <- read.csv("./Data/chemical_limnology_of_north_temperate_lakes_lter_primary_study_lakes_nutrients_ph_and_carbon_ALL.csv",
stringsAsFactors = FALSE)
data.lter.nutrients <- data.lter.nutrients.orig
data.lter.nutrients$lakeid <- gsub("AL", "Allequash Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("BM", "Big Musky Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("CB", "Crystal Bog", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("CR", "Crystal Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("SP", "Sparkling Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("TB", "Trout Bog", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("TR", "Trout Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("FI", "Fish Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("ME", "Lake Mendota", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("MO", "Lake Monona", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("WI", "Lake Wingra", data.lter.nutrients$lakeid)
data.lter.nutrients <- filter(data.lter.nutrients, lakeid != "Fish Lake" & lakeid != "Lake Mendota" & lakeid != "Lake Monona" & lakeid != "Lake Wingra")
#read in here - calculated in script but currently not, because takes a while to calculate...
mix<-read.csv("./Data/mix.csv", stringsAsFactors = FALSE)
#######################################################################
############### LTER data - nutrients & physical ######################
#######################################################################
########################## physical data ##############################
#only first replicate
data.lter.phys <- data.lter.phys[which(data.lter.phys$rep==1),]
#made date column a date
data.lter.phys$sampledate <- as.Date(data.lter.phys$sampledate, format = "%m/%d/%Y")
#remove columns with flags - not doing any sort of filtering by flag or sloh at this time
#also not doing anything with light at this time
data.lter.phys <- select(data.lter.phys, lakeid, year4, daynum, sampledate, depth, maxdepth.t, rep, sta, wtemp, o2)
#correct incorrect (as per discussion with Noah Lottig?) O2 measurement for Sparkling Lake
#water temp and O2 had been switched in downloaded data
which_correct_Sparkling_18Jan2011<-which(data.lter.phys$lakeid=="SP" & data.lter.phys$sampledate=="2011-01-18")
wtemp_correct<-data.lter.phys$o2[which_correct_Sparkling_18Jan2011]
wo2_correct<-data.lter.phys$wtemp[which_correct_Sparkling_18Jan2011]
data.lter.phys$wtemp[which_correct_Sparkling_18Jan2011]<-wtemp_correct
data.lter.phys$o2[which_correct_Sparkling_18Jan2011]<-wo2_correct
###################################################################################################
############################## LEGACY CODE - IGNORE FOR NOW #######################################
###################################################################################################
#summarize monthly water temp and o2
#wtempO2.monthly <- subset(data.lter.phys,data.lter.phys$depth>-1) %>%
#  group_by(lakeid,sta,year4,month=as.character(format(sampledate,"%b"))) %>%
#  dplyr::summarize(temp_mean=mean(wtemp, na.rm=TRUE),o2_mean=mean(o2sat, na.rm=TRUE))
do<-0
if(do==1){
sumO2.df <- subset(data.lter.phys,data.lter.phys$depth>-1 & data.lter.phys$o2>0)[order(data.lter.phys$lakeid,
data.lter.phys$sampledate,data.lter.phys$sta,data.lter.phys$depth),]
sumO2.df <- sumO2.df %>%
group_by(lakeid,sta,year4,sampledate) %>%
dplyr::mutate(int0=depth-lag(depth),int=ifelse(is.na(int0)==TRUE,1,int0)) %>% as.data.frame()
sumO2.df <- sumO2.df %>%
group_by(lakeid,sta,year4,sampledate) %>%
dplyr::summarize(O2_sum=sum(o2*int)/max(depth)) %>% as.data.frame()
sumO2.monthly <- sumO2.df %>%
group_by(lakeid,sta,year4,month=as.character(format(sampledate,"%b"))) %>%
dplyr::summarize(O2_sum=mean(O2_sum))
}
######################################################################################################
#### CHANGED TO BE MAXDEPTH.T
#new O2 aggregation
sumO2.df <- data.lter.phys
O2ct <- data.lter.phys %>%
group_by(lakeid,sta,sampledate) %>%
dplyr::summarize(n=sum(o2>0,na.rm=TRUE)) %>% as.data.frame()
O2ct<-O2ct[which(O2ct$n>=2),]
sumO2.df <- merge(sumO2.df,O2ct,by=c("lakeid","sta","sampledate"))
#sumO2.df <- sumO2.df%>%
#group_by(lakeid,sta,year4,sampledate) %>%
#dplyr::mutate(int0=depth-lag(depth),int=ifelse(is.na(int0)==TRUE,1,int0)) %>% as.data.frame()
#merge lake elevations with sumO2.df
#sumO2.df <- rename(sumO2.df, year = year4)
#data.elevs.merge <- rename(data.elevs, year = yr_winter)
#sumO2.df.merge <- merge(sumO2.df, data.elevs.merge, by = c("lakeid", "year"))
sumO2.df.summary <- sumO2.df %>%
group_by(lakeid,sta,year4,sampledate) %>% arrange(lakeid,sta,year4,depth) %>%
#calculating auc (from MESS package) - which is area under curve for oxygen vs depth - mg*m/L
#area under curve here is area below deepest sample, to bottom of lake
#(assuming o2 is same as deepest sample - best we can do)
dplyr::summarize(O2_auc=auc(type="spline",x=c(depth, last(maxdepth.t)),y=c(o2,last(o2))),
#back to mg/L units - but for whole water column
O2_sum=mean(O2_auc/maxdepth.t, na.rm = TRUE)) %>% as.data.frame()
sumO2.monthly <- sumO2.df.summary %>%
group_by(lakeid,sta,year4,month=as.character(format(sampledate,"%b"))) %>%
dplyr::summarize(O2_sum=mean(O2_sum))
############################## LEGACY CODE - IGNORE FOR NOW #################################
#wtemp.monthly<-wtempO2.monthly
#o2.monthly<-wtempO2.monthly
#wtemp.monthly$month<-paste("wtemp_",wtemp.monthly$month,sep="")
#o2.monthly$month<-paste("o2_",o2.monthly$month,sep="")
#sumO2.monthly$month<-paste("sumO2_",sumO2.monthly$month,sep="")
#wtemp.monthly <- spread(wtemp.monthly %>% select(-o2_mean),key=month,value=temp_mean) %>% as.data.frame()
#o2.monthly <- spread(o2.monthly %>% select(-temp_mean),key=month,value=o2_mean) %>% as.data.frame()
#sumO2.monthly <- spread(sumO2.monthly,key=month,value=O2_sum) %>% as.data.frame()
#wtemp.o2monthly<-merge(wtemp.monthly,o2.monthly,by=c("lakeid","year4","sta"))
#wtemp.o2monthly<-merge(wtemp.o2monthly,sumO2.monthly,by=c("lakeid","year4","sta"))
#############################################################################################
#### still needed, but already output (and takes a while, so set as do <- 0 so don't need to rerun every time) ####
data.lter.phys$lakestaday<-paste(data.lter.phys$lakeid,data.lter.phys$sta,data.lter.phys$sampledate)
data.lter.nutrients$lakestaday<-paste(data.lter.nutrients$lakeid,data.lter.nutrients$sta,data.lter.nutrients$sampledate)
lakestadays<-unique(data.lter.phys$lakestaday)
#######################################################################################
######## This codes uses the NTL-LTER data to investigate nutrient ####################
######## trends under lake ice. For a given lake, TDN/TDP/N:P is ######################
######## plotted against days since iceon. Depth is considered in #####################
######## different ways, with portions of code dedicated to determining ###############
######## hypsometrically weighted nutrient concentrations. Additionally, ##############
######## oxygen is investigated in relation to both nutrient concentrations ###########
######## and whole lake trends during iceon. Oxygen too! ##########################################
#######################################################################################
#################### Information about NTL-LTER data used here ########################
#Data was downloaded from the NTL-LTER public download page.
#chemical linology
#https://lter.limnology.wisc.edu/dataset/north-temperate-lakes-lter-chemical-limnology-primary-study-lakes-nutrients-ph-and-carbon-19
#://lter.limnology.wisc.edu/datafile/chemical-limnology-north-temperate-lakes-lter-primary-study-lakes-nutrients-ph-and-carbon
#this is CSV called "chemical_limnology_of_north_temperate_lakes_lter_primary_study_lakes_nutrients_ph_and_carbon_ALL.csv"
#nutrient samples: measured at one station in the deepest part of each lake at the top and bottom of the epilimnion, mid-thermocline, and top, middle, and bottom of the hypolimnion
#physical limnology, including oxygen
#https://lter.limnology.wisc.edu/dataset/north-temperate-lakes-lter-physical-limnology-primary-study-lakes-1981-current
#measured at one station in the deepest part of each lake at 0.25-m to 1-m depth intervals depending on the lake.
#this is CSV called "physical_limnology_of_the_north_temperate_lakes_primary_study_lakes_ALL.csv"
#snow and ice data: https://lter.limnology.wisc.edu/dataset/north-temperate-lakes-lter-snow-and-ice-depth-1982-current
############################################################################
################ start session and set up dependencies #####################
############################################################################
rm(list = ls())
#base_dir<-"/Users/steve.powers/Desktop/Sandboxes/2016Mar8pm_IcePowers"
start_dir<-as.character(getwd())
base_dir<-start_dir
#base_dir<-substr(start_dir,1,nchar(start_dir)-nchar("/Scripts"))
data_dir<-paste(base_dir,"/Data",sep="")
figs_dir<-paste(base_dir,"/Figures",sep="")
#base_dir<-"/Users/spowers/Desktop/Sandboxes/2016Mar16"
#data_dir<-paste(c(base_dir,"/DataAsText"),collapse="")
setwd(base_dir)
library(plyr)
library(dplyr)
library(ggplot2)
library(grid)
library(tidyr)
library(MESS)
#library(lme4)
#######################################################################
####################### read in data - all ############################
#################### do some renameing, etc. ##########################
#######################################################################
#read in original synthesis data for Wisconsin lakes
data.agg.orig <- read.csv("./Data/wisconsin_under_ice_aggregate_lakes.csv", stringsAsFactors = FALSE)
#elevations (see script...)
data.elevs.orig <- read.csv("./Data/final_elevs.csv", stringsAsFactors = FALSE)
data.elevs <- data.elevs.orig %>% rename(year4 = yr_winter)
#physical limnology data for LTER lakes
data.lter.phys.orig <- read.csv("./Data/physical_limnology_of_the_north_temperate_lakes_primary_study_lakes_ALL.csv",
stringsAsFactors = FALSE)
data.lter.phys <- data.lter.phys.orig
data.lter.phys$lakeid <- gsub("AL", "Allequash Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("BM", "Big Musky Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("CB", "Crystal Bog", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("CR", "Crystal Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("SP", "Sparkling Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("TB", "Trout Bog", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("TR", "Trout Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("FI", "Fish Lake", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("ME", "Lake Mendota", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("MO", "Lake Monona", data.lter.phys$lakeid)
data.lter.phys$lakeid <- gsub("WI", "Lake Wingra", data.lter.phys$lakeid)
data.lter.phys <- filter(data.lter.phys, lakeid != "Fish Lake" & lakeid != "Lake Mendota" & lakeid != "Lake Monona" & lakeid != "Lake Wingra")
#merge physical and lake_elev data
data.lter.phys <- merge(data.lter.phys, data.elevs, by = c("lakeid", "year4"))
#nutrient data for LTER lakes
data.lter.nutrients.orig <- read.csv("./Data/chemical_limnology_of_north_temperate_lakes_lter_primary_study_lakes_nutrients_ph_and_carbon_ALL.csv",
stringsAsFactors = FALSE)
data.lter.nutrients <- data.lter.nutrients.orig
data.lter.nutrients$lakeid <- gsub("AL", "Allequash Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("BM", "Big Musky Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("CB", "Crystal Bog", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("CR", "Crystal Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("SP", "Sparkling Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("TB", "Trout Bog", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("TR", "Trout Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("FI", "Fish Lake", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("ME", "Lake Mendota", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("MO", "Lake Monona", data.lter.nutrients$lakeid)
data.lter.nutrients$lakeid <- gsub("WI", "Lake Wingra", data.lter.nutrients$lakeid)
data.lter.nutrients <- filter(data.lter.nutrients, lakeid != "Fish Lake" & lakeid != "Lake Mendota" & lakeid != "Lake Monona" & lakeid != "Lake Wingra")
#read in here - calculated in script but currently not, because takes a while to calculate...
mix<-read.csv("./Data/mix.csv", stringsAsFactors = FALSE)
#######################################################################
############### LTER data - nutrients & physical ######################
#######################################################################
########################## physical data ##############################
#only first replicate
data.lter.phys <- data.lter.phys[which(data.lter.phys$rep==1),]
#made date column a date
data.lter.phys$sampledate <- as.Date(data.lter.phys$sampledate, format = "%m/%d/%Y")
#remove columns with flags - not doing any sort of filtering by flag or sloh at this time
#also not doing anything with light at this time
data.lter.phys <- select(data.lter.phys, lakeid, year4, daynum, sampledate, depth, maxdepth.t, rep, sta, wtemp, o2)
#correct incorrect (as per discussion with Noah Lottig?) O2 measurement for Sparkling Lake
#water temp and O2 had been switched in downloaded data
which_correct_Sparkling_18Jan2011<-which(data.lter.phys$lakeid=="SP" & data.lter.phys$sampledate=="2011-01-18")
wtemp_correct<-data.lter.phys$o2[which_correct_Sparkling_18Jan2011]
wo2_correct<-data.lter.phys$wtemp[which_correct_Sparkling_18Jan2011]
data.lter.phys$wtemp[which_correct_Sparkling_18Jan2011]<-wtemp_correct
data.lter.phys$o2[which_correct_Sparkling_18Jan2011]<-wo2_correct
###################################################################################################
############################## LEGACY CODE - IGNORE FOR NOW #######################################
###################################################################################################
#summarize monthly water temp and o2
#wtempO2.monthly <- subset(data.lter.phys,data.lter.phys$depth>-1) %>%
#  group_by(lakeid,sta,year4,month=as.character(format(sampledate,"%b"))) %>%
#  dplyr::summarize(temp_mean=mean(wtemp, na.rm=TRUE),o2_mean=mean(o2sat, na.rm=TRUE))
do<-0
if(do==1){
sumO2.df <- subset(data.lter.phys,data.lter.phys$depth>-1 & data.lter.phys$o2>0)[order(data.lter.phys$lakeid,
data.lter.phys$sampledate,data.lter.phys$sta,data.lter.phys$depth),]
sumO2.df <- sumO2.df %>%
group_by(lakeid,sta,year4,sampledate) %>%
dplyr::mutate(int0=depth-lag(depth),int=ifelse(is.na(int0)==TRUE,1,int0)) %>% as.data.frame()
sumO2.df <- sumO2.df %>%
group_by(lakeid,sta,year4,sampledate) %>%
dplyr::summarize(O2_sum=sum(o2*int)/max(depth)) %>% as.data.frame()
sumO2.monthly <- sumO2.df %>%
group_by(lakeid,sta,year4,month=as.character(format(sampledate,"%b"))) %>%
dplyr::summarize(O2_sum=mean(O2_sum))
}
######################################################################################################
#### CHANGED TO BE MAXDEPTH.T
#new O2 aggregation
sumO2.df <- data.lter.phys
O2ct <- data.lter.phys %>%
group_by(lakeid,sta,sampledate) %>%
dplyr::summarize(n=sum(o2>0,na.rm=TRUE)) %>% as.data.frame()
O2ct<-O2ct[which(O2ct$n>=2),]
sumO2.df <- merge(sumO2.df,O2ct,by=c("lakeid","sta","sampledate"))
#sumO2.df <- sumO2.df%>%
#group_by(lakeid,sta,year4,sampledate) %>%
#dplyr::mutate(int0=depth-lag(depth),int=ifelse(is.na(int0)==TRUE,1,int0)) %>% as.data.frame()
#merge lake elevations with sumO2.df
#sumO2.df <- rename(sumO2.df, year = year4)
#data.elevs.merge <- rename(data.elevs, year = yr_winter)
#sumO2.df.merge <- merge(sumO2.df, data.elevs.merge, by = c("lakeid", "year"))
sumO2.df.summary <- sumO2.df %>%
group_by(lakeid,sta,year4,sampledate) %>% arrange(lakeid,sta,year4,depth) %>%
#calculating auc (from MESS package) - which is area under curve for oxygen vs depth - mg*m/L
#area under curve here is area below deepest sample, to bottom of lake
#(assuming o2 is same as deepest sample - best we can do)
dplyr::summarize(O2_auc=auc(type="spline",x=c(depth, last(maxdepth.t)),y=c(o2,last(o2))),
#back to mg/L units - but for whole water column
O2_sum=mean(O2_auc/maxdepth.t, na.rm = TRUE)) %>% as.data.frame()
sumO2.monthly <- sumO2.df.summary %>%
group_by(lakeid,sta,year4,month=as.character(format(sampledate,"%b"))) %>%
dplyr::summarize(O2_sum=mean(O2_sum))
############################## LEGACY CODE - IGNORE FOR NOW #################################
#wtemp.monthly<-wtempO2.monthly
#o2.monthly<-wtempO2.monthly
#wtemp.monthly$month<-paste("wtemp_",wtemp.monthly$month,sep="")
#o2.monthly$month<-paste("o2_",o2.monthly$month,sep="")
#sumO2.monthly$month<-paste("sumO2_",sumO2.monthly$month,sep="")
#wtemp.monthly <- spread(wtemp.monthly %>% select(-o2_mean),key=month,value=temp_mean) %>% as.data.frame()
#o2.monthly <- spread(o2.monthly %>% select(-temp_mean),key=month,value=o2_mean) %>% as.data.frame()
#sumO2.monthly <- spread(sumO2.monthly,key=month,value=O2_sum) %>% as.data.frame()
#wtemp.o2monthly<-merge(wtemp.monthly,o2.monthly,by=c("lakeid","year4","sta"))
#wtemp.o2monthly<-merge(wtemp.o2monthly,sumO2.monthly,by=c("lakeid","year4","sta"))
#############################################################################################
#### still needed, but already output (and takes a while, so set as do <- 0 so don't need to rerun every time) ####
data.lter.phys$lakestaday<-paste(data.lter.phys$lakeid,data.lter.phys$sta,data.lter.phys$sampledate)
data.lter.nutrients$lakestaday<-paste(data.lter.nutrients$lakeid,data.lter.nutrients$sta,data.lter.nutrients$sampledate)
lakestadays<-unique(data.lter.phys$lakestaday)
